name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag (e.g. v0.2.0)'
        required: false

jobs:
  build-windows:
    name: Build Windows exe
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build web frontend
        run: pnpm web:build

      - name: Bundle TypeScript (tsup)
        run: pnpm build:ts

      - name: Package Windows exe
        run: npx @yao-pkg/pkg dist/cli.js --targets node20-win-x64 --output release/CurivAI.exe --compress GZip

      # Copy the native better-sqlite3 binding next to the exe
      # (pkg cannot bundle native .node files; they must ship alongside the exe)
      - name: Copy native SQLite binding
        shell: pwsh
        run: |
          $binding = Get-ChildItem -Recurse -Filter "better_sqlite3.node" node_modules | Select-Object -First 1
          if ($binding) {
            Copy-Item $binding.FullName release/better_sqlite3.node
            Write-Host "Copied: $($binding.FullName)"
          } else {
            Write-Error "better_sqlite3.node not found â€” build failed"
            exit 1
          }

      - name: Create release zip
        shell: pwsh
        run: |
          Compress-Archive -Path release/CurivAI.exe, release/better_sqlite3.node -DestinationPath release/CurivAI-windows-x64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CurivAI-windows-x64
          path: release/CurivAI-windows-x64.zip

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: release/CurivAI-windows-x64.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux binary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build web frontend
        run: pnpm web:build

      - name: Bundle TypeScript (tsup)
        run: pnpm build:ts

      - name: Package Linux binary
        run: npx @yao-pkg/pkg dist/cli.js --targets node20-linux-x64 --output release/curivai-linux --compress GZip

      - name: Copy native SQLite binding
        run: |
          binding=$(find node_modules -name "better_sqlite3.node" | head -1)
          if [ -z "$binding" ]; then
            echo "better_sqlite3.node not found" && exit 1
          fi
          cp "$binding" release/better_sqlite3.node

      - name: Create release tarball
        run: tar -czf release/CurivAI-linux-x64.tar.gz -C release curivai-linux better_sqlite3.node

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CurivAI-linux-x64
          path: release/CurivAI-linux-x64.tar.gz

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: release/CurivAI-linux-x64.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
